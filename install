#!/bin/bash

cd $(dirname $0)

source common_install.sh

find_conda_exe CONDA_EXE

CONDA_BIN=$(dirname ${CONDA_EXE})
CONDA_AGENT=$(${CONDA_EXE} info --json | jq -r '.user_agent')

echo "*** Installing environment Conda environment for Hummingbot ***"

ENV_FILE="setup/environment.yml"

ENV_FILE=$(get_env_file ${ENV_FILE})

ENV_NAME=$(get_env_name ${ENV_FILE})

if ${CONDA_EXE} env list | awk '{ print $1 }' | egrep -e "^${ENV_NAME}$" 1>/dev/null; then
    ${CONDA_EXE} env update -f $ENV_FILE --prune
else
    ${CONDA_EXE} env create -f $ENV_FILE
fi

source "${CONDA_BIN}/activate" ${ENV_NAME}

# Installing conflicting pip packages without their dependencies
# They could override the environment plan with conda
echo "Installing conflicting pip packages without their dependencies"
pip install --no-deps -r setup/pip_packages.txt 1> logs/pip_install.log 2>&1
pre-commit install
